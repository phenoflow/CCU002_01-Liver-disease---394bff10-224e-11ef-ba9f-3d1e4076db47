# Rochelle Knight, Venexia Walker, et al., 2024.

import sys, csv, re

codes = [{"code":"Chronic passive congestion of liver","system":"icd10"},{"code":"Portal and splenic vein sclerosis","system":"icd10"},{"code":"Portal cirrhosis","system":"icd10"},{"code":"Chronic viral hepatitis C","system":"icd10"},{"code":"Hepatic failure","system":"icd10"},{"code":"Intrahepatic phlebosclerosis and fibrosis","system":"icd10"},{"code":"Heterotopic liver transplant","system":"icd10"},{"code":"Compensation for liver failure NOS","system":"icd10"},{"code":"Balln tamponade oesophagus using Sengstaken-Blakemore tube","system":"icd10"},{"code":"Balloon tamponade of oesophagus using Minnesota tube","system":"icd10"},{"code":"Congenital absence of hepatic ducts","system":"icd10"},{"code":"Chronic liver disease NOS","system":"icd10"},{"code":"Unilobular portal cirrhosis","system":"icd10"},{"code":"Biliary atresia NOS","system":"icd10"},{"code":"Juvenile portal cirrhosis","system":"icd10"},{"code":"Autoimmune hepatitis","system":"icd10"},{"code":"[X]Oesophageal varices in diseases classified elsewhere","system":"icd10"},{"code":"Exploration liver (& transplanted)","system":"icd10"},{"code":"Fibreoptic oesophagoscopy & injection sclerotherapy varices","system":"icd10"},{"code":"Liver failure NOS","system":"icd10"},{"code":"Alcoholic cirrhosis of liver","system":"icd10"},{"code":"Toxic liver disease with chronic lobular hepatitis","system":"icd10"},{"code":"Chronic lobular hepatitis","system":"icd10"},{"code":"Progressive neuronal degeneration with liver cirrhosis","system":"icd10"},{"code":"Oesophageal varices without bleeding in diseases EC","system":"icd10"},{"code":"[X]Other and unspecified cirrhosis of liver","system":"icd10"},{"code":"[V]Assessment for liver transplant","system":"icd10"},{"code":"Fulminant hepatic failure","system":"icd10"},{"code":"Secondary biliary cirrhosis","system":"icd10"},{"code":"Infectious cirrhosis","system":"icd10"},{"code":"Primary biliary cirrhosis","system":"icd10"},{"code":"Oesophageal varices in diseases EC","system":"icd10"},{"code":"Acute hepatic failure due to drugs","system":"icd10"},{"code":"Mixed portal cirrhosis","system":"icd10"},{"code":"Chronic viral hepatitis","system":"icd10"},{"code":"Chronic hepatitis unspecified","system":"icd10"},{"code":"Hepatorenal syndrome as a complication of care","system":"icd10"},{"code":"Hepatic granulomas in sarcoidosis","system":"icd10"},{"code":"Alcoholic liver damage NOS","system":"icd10"},{"code":"Cardiac portal cirrhosis","system":"icd10"},{"code":"Chronic hepatic failure","system":"icd10"},{"code":"Liver transplant failure and rejection","system":"icd10"},{"code":"Bleeding oesophageal varices","system":"icd10"},{"code":"Viral hepatitis C with coma","system":"icd10"},{"code":"Cardiac cirrhosis","system":"icd10"},{"code":"Toxic liver disease with fibrosis and cirrhosis of liver","system":"icd10"},{"code":"Portal cirrhosis unspecified","system":"icd10"},{"code":"Cirrhosis - non-alcoholic","system":"icd10"},{"code":"Chronic viral hepatitis B without delta-agent","system":"icd10"},{"code":"Fibrosis of liver","system":"icd10"},{"code":"Infectious cirrhosis NOS","system":"icd10"},{"code":"Orthotopic transplantation of whole liver","system":"icd10"},{"code":"Toxic portal cirrhosis","system":"icd10"},{"code":"[X]Unspecified viral hepatitis with coma","system":"icd10"},{"code":"Cirrhosis: [juv portal] or [childh funct] or [Indian childh]","system":"icd10"},{"code":"Liver transplant disorder","system":"icd10"},{"code":"Hepatorenal syndrome","system":"icd10"},{"code":"Replacement of previous liver transplant","system":"icd10"},{"code":"Intrahepatic biliary atresia","system":"icd10"},{"code":"Liver cirrhos: [named vars] or [NOS]) or (hepat fibrosis)","system":"icd10"},{"code":"Oesophageal varices without bleeding","system":"icd10"},{"code":"Cirrhosis - non alcoholic) or (portal cirrhosis)","system":"icd10"},{"code":"Primary sclerosing cholangitis","system":"icd10"},{"code":"Chronic persistent hepatitis","system":"icd10"},{"code":"Fatty portal cirrhosis","system":"icd10"},{"code":"Cirrhosis of liver","system":"icd10"},{"code":"Chronic viral hepatitis B","system":"icd10"},{"code":"Alagille syndrome","system":"icd10"},{"code":"Portal fibrosis without cirrhosis","system":"icd10"},{"code":"Toxic liver disease with chronic active hepatitis","system":"icd10"},{"code":"Hypoxia-associated cirrhosis","system":"icd10"},{"code":"Transplantation of liver cells","system":"icd10"},{"code":"Alcoholic liver damage unspecified","system":"icd10"},{"code":"Cirrhosis secondary to cholestasis","system":"icd10"},{"code":"Chronic yellow atrophy","system":"icd10"},{"code":"Liver transplant","system":"icd10"},{"code":"Other specified open operation on oesophageal varices","system":"icd10"},{"code":"Oesophageal varices in alcoholic cirrhosis of the liver","system":"icd10"},{"code":"Cirrhosis of liver NOS","system":"icd10"},{"code":"Congenital hypoplasia of bile duct","system":"icd10"},{"code":"Liver disease due to cystic fibrosis","system":"icd10"},{"code":"Recurrent hepatitis","system":"icd10"},{"code":"Alcoholic fatty liver","system":"icd10"},{"code":"Cirrhosis: [florid] or [alcoholic]","system":"icd10"},{"code":"Viral hepatitis with hepatic coma","system":"icd10"},{"code":"Diffuse nodular cirrhosis","system":"icd10"},{"code":"Subfulminant hepatic failure","system":"icd10"},{"code":"Chronic alcoholic hepatitis","system":"icd10"},{"code":"Macronodular cirrhosis","system":"icd10"},{"code":"Cystic fibrosis related cirrhosis","system":"icd10"},{"code":"Extrahepatic biliary atresia","system":"icd10"},{"code":"Rigid oesophagoscopy and banding of oesophageal varices","system":"icd10"},{"code":"Laennec's cirrhosis, non-alcoholic","system":"icd10"},{"code":"Atresia of hepatic ducts","system":"icd10"},{"code":"Open operations on oesophageal varices","system":"icd10"},{"code":"[X]Other chronic viral hepatitis","system":"icd10"},{"code":"Congenital hepatic fibrosis","system":"icd10"},{"code":"Alcoholic liver disease","system":"icd10"},{"code":"Syphilitic portal cirrhosis","system":"icd10"},{"code":"Biliary cirrhosis of children","system":"icd10"},{"code":"Hepatic failure NOS","system":"icd10"},{"code":"Subacute hepatic failure","system":"icd10"},{"code":"Chronic active hepatitis","system":"icd10"},{"code":"Liver transplant rejection","system":"icd10"},{"code":"Chronic hepatitis","system":"icd10"},{"code":"Chronic viral hepatitis B with hepatitis D","system":"icd10"},{"code":"[X]Chronic viral hepatitis, unspecified","system":"icd10"},{"code":"Alcoholic fibrosis and sclerosis of liver","system":"icd10"},{"code":"Cirrhosis: [cardiac portal] or [congestive]","system":"icd10"},{"code":"Multilobular portal cirrhosis","system":"icd10"},{"code":"Toxic liver disease with chronic persistent hepatitis","system":"icd10"},{"code":"Bacterial portal cirrhosis","system":"icd10"},{"code":"Atresia of bile ducts","system":"icd10"},{"code":"Biliary cirrhosis (& [primary])","system":"icd10"},{"code":"Chronic hepatitis NOS","system":"icd10"},{"code":"Other non-alcoholic chronic liver disease","system":"icd10"},{"code":"Chronic hepatitis annual review","system":"icd10"},{"code":"Oesophageal varices NOS","system":"icd10"},{"code":"Indian childhood cirrhosis","system":"icd10"},{"code":"Pigmentary portal cirrhosis","system":"icd10"},{"code":"Cryptogenic cirrhosis","system":"icd10"},{"code":"Chronic hepatitis (& [NOS]/[active B]/[active]/[persistent])","system":"icd10"},{"code":"Pericellular fibrosis of congenital syphilis","system":"icd10"},{"code":"Rigid oesophagoscopy and injection sclerotherapy of varices","system":"icd10"},{"code":"Open operation on oesophageal varices NOS","system":"icd10"},{"code":"Drug-induced chronic hepatitis","system":"icd10"},{"code":"Oesophageal varices in diseases EC NOS","system":"icd10"},{"code":"Cirrhosis of liver: [multilobular portal] or [postnecrotic]","system":"icd10"},{"code":"Balloon tamponade of oesophagus","system":"icd10"},{"code":"Hepatic sclerosis","system":"icd10"},{"code":"Liver abscess and sequelae of chronic liver disease","system":"icd10"},{"code":"Atresia of bile duct (& [intrahepatic] or [extrahepatic]","system":"icd10"},{"code":"Oesophageal varices","system":"icd10"},{"code":"[V]Liver transplanted","system":"icd10"},{"code":"Transplantation of liver NOS","system":"icd10"},{"code":"Alcoholic hepatic failure","system":"icd10"},{"code":"Toxic cirrhosis","system":"icd10"},{"code":"Chronic non-A non-B hepatitis","system":"icd10"},{"code":"Pipestem portal cirrhosis","system":"icd10"},{"code":"Hepatic fibrosis with hepatic sclerosis","system":"icd10"},{"code":"Portal hypertension","system":"icd10"},{"code":"Fibreoptic oesophagoscopy and banding of oesophageal varices","system":"icd10"},{"code":"Capsular portal cirrhosis","system":"icd10"},{"code":"Oesophageal varices with bleeding in diseases EC","system":"icd10"},{"code":"Cirrhosis and chronic liver disease","system":"icd10"},{"code":"Open injection sclerotherapy to oesophageal varices","system":"icd10"},{"code":"Non-alcoholic cirrhosis NOS","system":"icd10"},{"code":"Ichthyosis congenita with biliary atresia","system":"icd10"},{"code":"Florid cirrhosis","system":"icd10"},{"code":"Hepatic failure as a complication of care","system":"icd10"},{"code":"Gastric varices","system":"icd10"},{"code":"Biliary cirrhosis NOS","system":"icd10"},{"code":"Local ligation of oesophageal varices","system":"icd10"},{"code":"Oesophageal varices in cirrhosis of the liver","system":"icd10"},{"code":"Exploration of liver transplant","system":"icd10"},{"code":"Micronodular cirrhosis","system":"icd10"},{"code":"Cirrhos &/or chron liver dis) or (alcoholic liver disease)","system":"icd10"},{"code":"Chronic aggressive hepatitis","system":"icd10"},{"code":"Acute hepatic failure","system":"icd10"},{"code":"Congenital absence of bile duct","system":"icd10"},{"code":"Alcoholic hepatitis","system":"icd10"},{"code":"Other specified transplantation of liver","system":"icd10"},{"code":"Acute alcoholic hepatitis","system":"icd10"},{"code":"Fibreopt endoscop rubber band ligation of upper GIT varices","system":"icd10"},{"code":"Liver transplant failure","system":"icd10"},{"code":"Biliary cirrhosis","system":"icd10"},{"code":"Orthotopic liver transplant","system":"icd10"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('ccu002_01-liver-disease-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["ccu002---secondary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["ccu002---secondary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["ccu002---secondary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
